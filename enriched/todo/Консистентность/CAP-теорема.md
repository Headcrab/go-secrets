#CAPtheorem
#database #distributed_systems #consistency #availability #partition_tolerance #nosql #acid #base

# Теорема CAP

```table-of-contents
```

## Введение в CAP-теорему

CAP-теорема, также известная как теорема Брюера, является фундаментальным принципом в области распределенных систем. Она утверждает, что в распределенной системе, которая хранит данные, невозможно одновременно гарантировать все три следующие свойства:

*   **Consistency (Согласованность):** Каждое чтение данных возвращает самую последнюю запись или ошибку. Это означает, что все узлы в системе видят одни и те же данные в один и тот же момент времени. Если данные обновляются, то все последующие запросы на чтение, независимо от того, к какому узлу они обращены, вернут обновленные данные.
*   **Availability (Доступность):** Каждый запрос получает ответ (без гарантии, что этот ответ содержит самую последнюю запись). Это означает, что система всегда отвечает на запросы, даже если некоторые узлы вышли из строя.
*   **Partition Tolerance (Устойчивость к разделению):** Система продолжает работать, несмотря на потерю сообщений или сбой части системы. Это означает, что система может выдерживать сетевые разделения, когда связь между некоторыми узлами теряется.

Теорема утверждает, что в случае сетевого разделения (Partition) необходимо выбирать между Согласованностью (Consistency) и Доступностью (Availability). Невозможно обеспечить все три гарантии одновременно.

## Детальное рассмотрение свойств CAP

### Consistency (Согласованность)

Согласованность в контексте CAP-теоремы относится к *линейной согласованности* ([[Linearizability]]). Это самая сильная форма согласованности. Она означает, что каждая операция выглядит так, как будто она выполняется атомарно (неделимо) и в определенном порядке, который соответствует глобальному порядку выполнения операций.

Представьте себе ситуацию: два клиента одновременно пытаются изменить одно и то же значение в базе данных. Без строгой согласованности, один клиент может прочитать старое значение, даже после того, как другой клиент успешно выполнил запись. Линейная согласованность гарантирует, что этого не произойдет. Все клиенты будут видеть изменения в одном и том же порядке.

Существуют и другие, более слабые модели согласованности, такие как *согласованность в конечном счете* ([[Eventual Consistency]]). При такой модели данные со временем станут согласованными, но нет гарантии, что сразу после записи все клиенты увидят новые данные.

### Availability (Доступность)

Доступность означает, что каждый запрос к системе, не завершившийся ошибкой, должен получить ответ. Важно отметить, что это не гарантирует, что ответ будет содержать самые последние данные (это относится к согласованности). Система считается доступной, если она может обрабатывать запросы, даже если некоторые из ее узлов недоступны.

Высокая доступность часто достигается за счет репликации данных. Если один узел выходит из строя, запросы могут быть перенаправлены на другие узлы, содержащие копии данных.

### Partition Tolerance (Устойчивость к разделению)

Устойчивость к разделению означает, что система продолжает функционировать, несмотря на сетевые сбои, которые приводят к разделению системы на несколько изолированных частей (разделов). В распределенной системе сетевые сбои неизбежны, поэтому устойчивость к разделению является обязательным требованием.

Сетевое разделение может произойти по разным причинам: сбой сетевого оборудования, проблемы с подключением к Интернету, временная недоступность узлов и т. д. В такой ситуации система должна выбрать, как она будет себя вести:

*   **Отдать приоритет согласованности:** В этом случае система может временно стать недоступной для некоторых запросов, чтобы предотвратить расхождение данных между разделами.
*   **Отдать приоритет доступности:** В этом случае система продолжит обрабатывать запросы в каждом разделе, но данные могут стать несогласованными.

## Выбор между Consistency и Availability

CAP-теорема утверждает, что при наличии сетевого разделения (Partition) необходимо выбирать между согласованностью (Consistency) и доступностью (Availability). Это компромисс, который приходится делать при проектировании распределенных систем.

### CP (Consistency and Partition Tolerance)

Системы, выбирающие CP, отдают приоритет согласованности данных над доступностью. В случае сетевого разделения такие системы могут стать частично или полностью недоступными, чтобы предотвратить расхождение данных. Примеры CP-систем:

*   **HBase:** Колоночная база данных, построенная поверх Hadoop.
*   **MongoDB (с определенными настройками):** Документо-ориентированная база данных, которая может быть настроена для обеспечения строгой согласованности.
*   **ZooKeeper:** Сервис координации для распределенных приложений.
*   **Google Spanner:** Глобально распределенная база данных, обеспечивающая строгую согласованность.

Пример: Банковская транзакция. Важно, чтобы все операции с деньгами были согласованы. Если произойдет сетевой сбой, лучше временно приостановить транзакции, чем допустить несогласованность балансов счетов.

### AP (Availability and Partition Tolerance)

Системы, выбирающие AP, отдают приоритет доступности над согласованностью. В случае сетевого разделения такие системы продолжат обрабатывать запросы в каждом разделе, даже если это может привести к временной несогласованности данных. Примеры AP-систем:

*   **Cassandra:** Широко-колоночная база данных, разработанная для высокой доступности и масштабируемости.
*   **DynamoDB:** Ключ-значение и документо-ориентированная база данных от Amazon.
*   **Riak:** Распределенная база данных ключ-значение.
*   **CouchDB:** Документо-ориентированная база данных.

Пример: Система подсчета "лайков" в социальной сети. Небольшая задержка в обновлении счетчика "лайков" не критична, важнее, чтобы пользователи всегда могли поставить "лайк", даже если часть серверов недоступна.

### CA (Consistency and Availability) – нереализуемо в распределенной среде

Теоретически, можно создать систему, которая обеспечивает и согласованность, и доступность, но только в отсутствие сетевых разделений. В реальных распределенных системах сетевые сбои неизбежны, поэтому CA-системы не могут быть реализованы на практике. Традиционные реляционные базы данных (например, PostgreSQL, MySQL) часто работают в режиме CA в рамках одного сервера, но при переходе к распределенной архитектуре они также сталкиваются с выбором между CP и AP.

## Уточнения и расширения CAP-теоремы

Важно понимать, что CAP-теорема – это упрощение. Реальные системы часто предлагают более тонкие настройки и компромиссы.

### Уровни согласованности

Вместо жесткого выбора между "согласованностью" и "несогласованностью" многие системы предлагают различные *уровни согласованности*. Например:

*   **Strong consistency (Строгая согласованность):** Все операции видны всем узлам немедленно и в одном и том же порядке.
*   **Read-your-writes consistency (Согласованность чтения собственных записей):** После выполнения записи клиент гарантированно увидит свои изменения при последующих чтениях.
*   **Session consistency (Сессионная согласованность):** В рамках одной сессии клиент видит согласованное представление данных.
*   **Monotonic reads consistency (Монотонная согласованность чтения):** Если клиент прочитал определенное значение, он никогда не увидит более старое значение при последующих чтениях.
*   **Eventual consistency (Согласованность в конечном счете):** Данные со временем станут согласованными, но нет никаких гарантий относительно того, когда это произойдет.

### PACELC-теорема

PACELC-теорема расширяет CAP-теорему, рассматривая поведение системы не только в случае сетевого разделения (Partition), но и в нормальном режиме работы.

*   **P (Partition):** Если происходит сетевое разделение...
*   **A (Availability):** ...выбираем между доступностью...
*   **C (Consistency):** ...и согласованностью.
*   **E (Else):** Иначе (в нормальном режиме работы)...
*   **L (Latency):** ...выбираем между низкой задержкой...
*   **C (Consistency):** ...и согласованностью.

PACELC-теорема показывает, что даже в отсутствие сетевых сбоев существует компромисс между задержкой и согласованностью. Например, для снижения задержки можно использовать кэширование, но это может привести к временной несогласованности данных.

## Примеры использования CAP-теоремы при выборе базы данных

Выбор базы данных для конкретного приложения часто основывается на требованиях к согласованности, доступности и устойчивости к разделению.

### Сценарий 1: Электронная коммерция

Для системы электронной коммерции важна высокая доступность. Пользователи должны иметь возможность просматривать товары и добавлять их в корзину, даже если некоторые серверы недоступны. Небольшая задержка в обновлении информации о наличии товара менее критична, чем полная недоступность системы. В этом случае подойдет AP-система, такая как Cassandra или DynamoDB.

### Сценарий 2: Банковская система

Для банковской системы критически важна согласованность данных. Недопустимо, чтобы из-за сетевого сбоя произошла двойная трата средств или потеря информации о транзакциях. В этом случае подойдет CP-система, такая как HBase или Google Spanner.

### Сценарий 3: Социальная сеть

Для социальной сети важна как доступность, так и согласованность, но требования к согласованности могут быть менее строгими, чем в банковской системе. Можно использовать систему с "согласованностью в конечном счете", такую как Cassandra.

## Заключение

CAP-теорема является важным инструментом для понимания компромиссов при проектировании распределенных систем. Она помогает разработчикам выбирать правильные технологии и архитектурные решения, исходя из требований к согласованности, доступности и устойчивости к разделению. Важно помнить, что CAP-теорема – это не жесткое ограничение, а скорее руководство к действию. Реальные системы часто предлагают более гибкие настройки и различные уровни согласованности. PACELC теорема расширяет CAP и помогает проектировать системы.

```old
CAP-теорема
```