#BSON #data #serialization #format #database #mongodb #binary #json #nosql #document

# BSON

```table-of-contents
```

## Обзор BSON

BSON (Binary JSON) - это двоичный формат сериализации данных, используемый для хранения документов и выполнения удаленных вызовов процедур (RPC) в MongoDB. Он представляет собой расширение формата JSON, дополненное типами данных, отсутствующими в стандартном JSON, и нацеленное на повышение эффективности хранения и обработки данных. BSON разработан для обеспечения скорости, простоты и гибкости.

## История и причины создания BSON

MongoDB, как документо-ориентированная база данных, требовала формата, который мог бы эффективно представлять сложные иерархические структуры данных. JSON, будучи популярным текстовым форматом обмена данными, имел ряд ограничений, которые делали его неоптимальным для использования в MongoDB:

1.  **Отсутствие поддержки некоторых типов данных:** JSON не поддерживает такие типы данных, как даты, двоичные данные, регулярные выражения и ссылки на объекты, которые важны для приложений баз данных.
2.  **Производительность:** JSON, будучи текстовым форматом, требует парсинга (преобразования текста в структуру данных) при чтении и записи, что может быть медленным для больших объемов данных.
3.  **Размер:** JSON может быть избыточным из-за использования текстовых ключей и значений, что увеличивает размер хранимых данных.

BSON был разработан, чтобы решить эти проблемы. Он предоставляет:

1.  **Поддержку дополнительных типов данных:** BSON включает типы данных, такие как Date, BinData, ObjectID, Regular Expression, и другие, что делает его более подходящим для представления данных в базе данных.
2.  **Эффективность:** BSON является двоичным форматом, что означает, что он хранится и обрабатывается в виде двоичных данных, а не текста. Это устраняет необходимость в парсинге и делает операции чтения и записи более быстрыми.
3.  **Компактность:** Хотя BSON может быть немного больше, чем эквивалентный JSON в некоторых случаях (из-за дополнительных метаданных), он часто более компактен для сложных документов из-за использования двоичных типов данных и возможности пропуска полей.
4. **Простота обхода:** BSON документы спроектированы так, чтобы их можно было легко и быстро обходить. Каждый элемент BSON документа содержит информацию о своем размере, что позволяет быстро переходить к следующим элементам без необходимости полного разбора всего документа.

## Структура BSON документа

BSON документ представляет собой упорядоченный список пар ключ-значение. Каждый элемент документа состоит из:

1.  **Тип данных (1 байт):** Указывает тип значения элемента.
2.  **Имя поля (null-terminated string):** Имя поля, представленное строкой в кодировке UTF-8, завершающейся нулевым байтом.
3.  **Значение:** Значение элемента, формат которого зависит от типа данных.

Пример структуры BSON документа (в упрощенном виде):

```
<document> ::= <int32> <element_list> <byte>
<element_list> ::= <element> <element_list> | ""
<element> ::= <type> <name> <value>
<type> ::= "\x01" | "\x02" | ... | "\x13"  // Коды типов данных
<name> ::= <cstring> // Строка, завершающаяся нулем
<value> ::= ... // Зависит от типа данных
```

Где:

*   `<int32>`: 4-байтовое целое число, указывающее общий размер документа.
*   `<element_list>`: Список элементов.
*   `<byte>`: Нулевой байт, обозначающий конец документа.
*   `<element>`: Отдельный элемент, состоящий из типа, имени и значения.
*    `<type>` код типа данных.
*   `<name>` имя поля.
*   `<value>` значение поля, формат которого зависит от типа данных.

## Типы данных BSON

BSON поддерживает широкий спектр типов данных, включая:

| Тип данных BSON                                                                                                                                                                                                                         | Код  | Описание                                                                                                                                                                                 | Пример в JSON (если применимо)                                                                                       |
| :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---: | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------- |
| Double                                                                                                                                                                                                                                | 0x01  | 64-битное число с плавающей точкой (IEEE 754).                                                                                                                                           | `3.14`                                                                                                               |
| String                                                                                                                                                                                                                                | 0x02  | Строка в кодировке UTF-8, завершающаяся нулевым байтом.                                                                                                                               | `"hello"`                                                                                                              |
| Object (Embedded Document)                                                                                                                                                                                                             | 0x03  | Вложенный BSON-документ.                                                                                                                                                                 | `{"key": "value"}`                                                                                                    |
| Array                                                                                                                                                                                                                                 | 0x04  | Массив BSON-значений.                                                                                                                                                                    | `[1, 2, 3]`                                                                                                          |
| Binary Data                                                                                                                                                                                                                           | 0x05  | Двоичные данные. Состоит из подтипа (1 байт) и массива байтов.                                                                                                                          | (Нет прямого эквивалента)                                                                                             |
| Undefined (Deprecated)                                                                                                                                                                                                                   | 0x06  | Устаревший тип.  Ранее использовался для представления неопределенного значения.                                                                                                       | `null` (в некотором смысле)                                                                                          |
| ObjectId                                                                                                                                                                                                                              | 0x07  | 12-байтовый уникальный идентификатор. Обычно используется для первичных ключей в MongoDB.  Состоит из: 4 байта - timestamp, 5 байт - random value, 3 байта - incrementing counter. | (Нет прямого эквивалента)                                                                                             |
| Boolean                                                                                                                                                                                                                               | 0x08  | Логическое значение (true/false).                                                                                                                                                       | `true` / `false`                                                                                                     |
| Date                                                                                                                                                                                                                                 | 0x09  | 64-битное целое число, представляющее количество миллисекунд, прошедших с начала эпохи Unix (1 января 1970 года).                                                                  | (Нет прямого эквивалента, часто представляется строкой ISO 8601)                                                       |
| Null                                                                                                                                                                                                                                 | 0x0A  | Нулевое значение.                                                                                                                                                                        | `null`                                                                                                               |
| Regular Expression                                                                                                                                                                                                                    | 0x0B  | Регулярное выражение. Состоит из двух строк: шаблона и опций.                                                                                                                          | (Нет прямого эквивалента)                                                                                             |
| DBPointer (Deprecated)                                                                                                                                                                                                                  | 0x0C  | Устаревший тип. Ранее использовался для ссылок на другие документы в базе данных.                                                                                                     | (Нет прямого эквивалента)                                                                                             |
| JavaScript Code                                                                                                                                                                                                                         | 0x0D  | Код JavaScript.                                                                                                                                                                       | (Нет прямого эквивалента)                                                                                             |
| Symbol (Deprecated)                                                                                                                                                                                                                     | 0x0E  | Устаревший тип. Ранее использовался для представления символов (аналогично символам в Ruby).                                                                                             | (Нет прямого эквивалента)                                                                                             |
| JavaScript Code with Scope                                                                                                                                                                                                          | 0x0F  | Код JavaScript с областью видимости (переменными).                                                                                                                                     | (Нет прямого эквивалента)                                                                                             |
| 32-bit Integer                                                                                                                                                                                                                        | 0x10  | 32-битное целое число.                                                                                                                                                                  | `123`                                                                                                                |
| Timestamp                                                                                                                                                                                                                             | 0x11  | Специальный тип данных для внутреннего использования MongoDB.  64-битное значение, состоящее из двух 32-битных частей:  время и порядковый номер операции.                              | (Нет прямого эквивалента)                                                                                             |
| 64-bit Integer                                                                                                                                                                                                                        | 0x12  | 64-битное целое число.                                                                                                                                                                  | `123456789012`                                                                                                       |
| Decimal128                                                                                                                                                                                                                            | 0x13  | 128-битное число с плавающей точкой (IEEE 754-2008 decimal128), предназначенное для хранения чисел с высокой точностью, например, финансовых данных.                                       | (Нет прямого эквивалента)                                                                                             |
| Min Key                                                                                                                                                                                                                               | 0xFF  | Специальное значение, которое меньше любого другого значения BSON.                                                                                                                        | (Нет прямого эквивалента)                                                                                             |
| Max Key                                                                                                                                                                                                                               | 0x7F  | Специальное значение, которое больше любого другого значения BSON.                                                                                                                        | (Нет прямого эквивалента)                                                                                             |

## Пример BSON документа

Рассмотрим пример JSON-документа:

```json
{
  "name": "John Doe",
  "age": 30,
  "address": {
    "street": "123 Main St",
    "city": "Anytown"
  },
  "hobbies": ["reading", "hiking"],
  "birthdate": "1993-05-10T14:30:00Z"
}
```

Его представление в BSON (в шестнадцатеричном виде) может выглядеть примерно так:

```
94000000 // Общий размер документа (148 байт)
02 // Тип данных: String
6E616D6500 // Имя поля: "name"
4A6F686E20446F6500 // Значение: "John Doe"
10 // Тип данных: 32-bit Integer
61676500 // Имя поля: "age"
1E000000 // Значение: 30
03 // Тип данных: Object (Embedded Document)
6164647265737300 // Имя поля: "address"
41000000 // Размер вложенного документа (65 байт)
  02 // Тип данных: String
  73747265657400 // Имя поля: "street"
  313233204D61696E20537400 // Значение: "123 Main St"
  02 // Тип данных: String
  6369747900 // Имя поля: "city"
  416E79746F776E00 // Значение: "Anytown"
  00 // Конец вложенного документа
04 // Тип данных: Array
686F626269657300  // Имя поля: "hobbies"
28000000 // Размер массива (40 байта)
  02 // Тип данных: String
  3000 // Индекс: "0"
  72656164696E6700 // Значение: "reading"
  02 // Тип данных: String
  3100 // Индекс: "1"
  68696B696E6700 // Значение: "hiking"
  00 // Конец массива
09 //Тип данных: Date
62697274686461746500 // Имя поля: "birthdate"
001882E148240000 //Значение
00 // Конец документа
```

Это упрощенный пример, и фактическое представление может немного отличаться в зависимости от используемой реализации BSON.

## Преимущества и недостатки BSON

**Преимущества:**

1.  **Скорость:** BSON разработан для обеспечения высокой скорости чтения и записи данных, особенно в контексте баз данных.
2.  **Поддержка типов данных:** BSON поддерживает широкий спектр типов данных, что делает его более гибким, чем JSON.
3.  **Простота обхода:** Структура BSON-документов позволяет легко и быстро обходить их, что важно для производительности баз данных.
4.  **Интеграция с MongoDB:** BSON является основным форматом данных для MongoDB, одной из самых популярных NoSQL баз данных.

**Недостатки:**

1.  **Читаемость:** BSON, будучи двоичным форматом, не предназначен для чтения человеком. Для просмотра BSON-документов требуются специальные инструменты.
2.  **Размер:** В некоторых случаях BSON-документы могут быть больше, чем эквивалентные JSON-документы из-за дополнительных метаданных.
3.  **Ограниченная поддержка вне MongoDB:** Хотя BSON поддерживается в некоторых других системах, он наиболее тесно связан с MongoDB.

## Сравнение BSON и JSON

| Характеристика        | BSON                                                                                                                                                                 | JSON                                                                                                                             |
| :--------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------- |
| Формат                | Двоичный                                                                                                                                                            | Текстовый                                                                                                                        |
| Читаемость            | Низкая (требуются специальные инструменты)                                                                                                                            | Высокая (можно прочитать в любом текстовом редакторе)                                                                            |
| Типы данных           | Поддерживает широкий спектр типов, включая Date, BinData, ObjectId, Regular Expression и другие.                                                                      | Поддерживает ограниченный набор типов: String, Number, Boolean, Null, Object, Array.                                                 |
| Размер                | В целом, более компактный для сложных данных, но может быть больше для простых.                                                                                     | Может быть избыточным из-за использования текстовых ключей и значений.                                                          |
| Производительность    | Более высокая скорость чтения и записи благодаря двоичному формату и отсутствию парсинга.                                                                            | Менее производительный из-за необходимости парсинга.                                                                            |
| Простота обхода     | Легко обходится благодаря информации о размере каждого элемента.                                                                                                      | Обход требует полного разбора документа.                                                                                      |
| Использование        | Основной формат данных для MongoDB. Также используется в некоторых других системах.                                                                                  | Широко используется в веб-разработке, API и конфигурационных файлах.                                                          |
| Стандартизация       | Спецификация BSON ([http://bsonspec.org/](http://bsonspec.org/))                                                                                                        | JSON стандартизирован RFC 8259 ([https://datatracker.ietf.org/doc/html/rfc8259](https://datatracker.ietf.org/doc/html/rfc8259)) |

## Применение BSON

Основное применение BSON – это хранение данных и RPC в MongoDB.  Однако, BSON может использоваться и в других приложениях, где требуется эффективная сериализация данных. Примеры:

1.  **Хранение данных:** BSON может использоваться для хранения данных в файлах или других хранилищах.
2.  **Сетевое взаимодействие:** BSON может использоваться для передачи данных по сети между приложениями.
3.  **Межпроцессное взаимодействие:** BSON может использоваться для обмена данными между процессами на одном компьютере.

## Реализации BSON

Существует множество реализаций BSON для различных языков программирования. Некоторые из них:

*   **Go:** `go.mongodb.org/mongo-driver/bson` (официальный драйвер MongoDB для Go)
*   **Java:** `org.bson` (пакет в драйвере MongoDB для Java)
*   **Python:** `bson` (пакет в PyMongo, драйвере MongoDB для Python)
*   **C#:** `MongoDB.Bson` (пакет в драйвере MongoDB для C#)
*   **JavaScript:** BSON поддерживается встроенными средствами в MongoDB shell и драйверами MongoDB для Node.js.
*   **Ruby:** `bson` (гем в драйвере MongoDB для Ruby)
*   **C++:** `libbson` (библиотека, входящая в состав драйвера MongoDB для C)

## Пример использования BSON в Go (с использованием официального драйвера MongoDB)

```go
package main

import (
	"fmt"
	"log"
	"time"

	"go.mongodb.org/mongo-driver/bson"
	"go.mongodb.org/mongo-driver/bson/primitive"
)

type Person struct {
	Name      string             `bson:"name"`
	Age       int                `bson:"age"`
	Address   Address            `bson:"address"`
	Hobbies   []string           `bson:"hobbies"`
	Birthdate primitive.DateTime `bson:"birthdate"`
	ID        primitive.ObjectID `bson:"_id,omitempty"`
}

type Address struct {
	Street string `bson:"street"`
	City   string `bson:"city"`
}

func main() {
	// Создание структуры Person
	person := Person{
		Name: "John Doe",
		Age:  30,
		Address: Address{
			Street: "123 Main St",
			City:   "Anytown",
		},
		Hobbies:   []string{"reading", "hiking"},
		Birthdate: primitive.NewDateTimeFromTime(time.Date(1993, 5, 10, 14, 30, 0, 0, time.UTC)),
		ID:        primitive.NewObjectID(),
	}

	// Маршалинг (кодирование) структуры Person в BSON
	bsonData, err := bson.Marshal(person)
	if err != nil {
		log.Fatal(err)
	}

	fmt.Printf("BSON data (hex): %X\n", bsonData)
    fmt.Printf("BSON data : %v\n", bsonData)

	// Анмаршалинг (декодирование) BSON-данных обратно в структуру Person
	var decodedPerson Person
	err = bson.Unmarshal(bsonData, &decodedPerson)
	if err != nil {
		log.Fatal(err)
	}

	fmt.Printf("Decoded person: %+v\n", decodedPerson)

	// Использование BSON-типов напрямую
	doc := bson.D{
		{"name", "Jane Doe"},
		{"age", 25},
		{"address", bson.D{
			{"street", "456 Elm St"},
			{"city", "Otherville"},
		}},
		{"hobbies", bson.A{"swimming", "coding"}},
		{"birthdate", primitive.NewDateTimeFromTime(time.Now())},
		{"_id", primitive.NewObjectID()},
	}

	bsonDoc, err := bson.Marshal(doc)
	if err != nil {
      log.Fatal(err)
	}
	fmt.Println(bsonDoc)

	// Фильтрация с использованием bson.D
	filter := bson.D{{"age", bson.D{{"$gt", 25}}}} // Фильтр: age > 25
	fmt.Println(filter)
}
```

Этот пример демонстрирует:

1.  **Определение структуры Go, соответствующей BSON-документу:**  Используются теги `bson` для указания соответствия полей структуры Go полям BSON-документа.
2.  **Маршалинг (кодирование) структуры Go в BSON:** Используется функция `bson.Marshal()`.
3.  **Анмаршалинг (декодирование) BSON-данных обратно в структуру Go:** Используется функция `bson.Unmarshal()`.
4.  **Использование BSON-типов напрямую:** `bson.D` для представления упорядоченных документов, `bson.A` для представления массивов, `primitive.DateTime` для представления даты и времени, `primitive.ObjectID` для представления ObjectId.
5. **Фильтрация** Создания фильтров для запросов к MongoDB.

## Заключение

BSON - это мощный и эффективный формат сериализации данных, который играет ключевую роль в работе MongoDB. Его двоичная природа, поддержка широкого спектра типов данных и оптимизация для скорости делают его идеальным выбором для документо-ориентированных баз данных. Хотя BSON наиболее тесно связан с MongoDB, он может использоваться и в других приложениях, где требуется эффективное представление и обработка сложных структур данных.

```old
BSON
```